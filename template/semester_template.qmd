---
title: "Semester Overview"
format:
  html:
    toc: true
    number-sections: true
params:
  semester: null
  required_weeks: 9
  require_obs_per_week: 4
editor_options: 
  chunk_output_type: console
---

```{r example-params, include=FALSE}
# Quick dev compile helper
if (FALSE) {
  params <- list(
    semester = "2025.2",
    required_weeks = 9,
    require_obs_per_week = 4
  )
}
```

```{r setup-libraries, echo=F, warning=FALSE, message=FALSE}
library(tidyverse)
library(DT)
library(ggplot2)
library(arrow)
```

```{r load-data, echo=F}
# Load global datasets
d_all <- read_parquet("data/processed/full_data.parquet")
d_obs_weekly_all <- read_parquet("data/processed/weekly_observer_stats.parquet")
d_obs_all <- read_parquet("data/processed/semester_observer_stats.parquet")

# Filter for this semester
ds <- d_all %>% filter(semester == params$semester)
ds_obs_weekly <- d_obs_weekly_all %>% filter(semester == params$semester)
ds_obs <- d_obs_all %>% filter(semester == params$semester)
```

## Semester: `r params$semester`

There are `r nrow(ds)` total observations this semester.

**Number of observers:** `r n_distinct(ds$observedby_person_id)`  
**Total observations:** `r nrow(ds)`

[Download CSV](https://github.com/AdamWilsonLabEDU/campus_phenology/releases/download/npn-data/npn_obs_network-891_semester-`r params$semester`.csv)

The NNID in the table and figures below is an anonymized individual observer ID. 

## Observer Overview

```{r observer-overview, echo=F}
ds %>%
  group_by(observedby_person_id) %>%
  summarize(total_obs = n()) %>%
  mutate(link = paste0("<a href='student_", params$semester, "_", observedby_person_id, ".html'>See details</a>")) %>%
  select(NNID = observedby_person_id, total_obs, link) %>%
  datatable(escape = FALSE)
```


## Weekly Observations Heatmap


The figure below visualizes the number of observations made by each observer during each week of the semester. 

```{r weekly-heatmap, echo=F, fig.height=12 }
if(nrow(ds) > 0) {
  ds %>%
    group_by(observedby_person_id, observation_week) %>%
    summarize(total_obs = n(), .groups = "drop") %>%
    ggplot(aes(x = observation_week, y = as.factor(observedby_person_id), fill = total_obs)) +
    geom_tile() +
    scale_fill_viridis_c(trans = "log1p") +
    xlab("Week of Semester") +
    ylab("Observer") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
}
```



## Phenology Observations by Species

```{r species-observations, echo=F}
if(nrow(ds) > 0) {
  ds %>%
    group_by(common_name) %>%
    summarize(n_obs = n()) %>%
    ggplot(aes(x = reorder(common_name, n_obs), y = n_obs)) +
    geom_col() +
    coord_flip() +
    ylab("Number of Observations") +
    xlab("Species")
}
```


